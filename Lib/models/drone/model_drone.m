%% MODEL_ROVER
% file: model_rover.m
% author: Federico Oliva
% date: 10/01/2022
% description: this function describes the dynamics equation of a rover
% t: time instant
% x: state vector
% params: structure with all the necessary parameters 
% obs: observer class instance (may be not used)
% OUTPUT:
% x_dot: dynamics equations
function [x_dot, x] = model_drone(tspan,x,params,obs)
    
    % init the dynamics 
    x_dot = zeros(length(x),1);

    % compute the time index
    for i=1:length(tspan)
        tdiff = obs.setup.time-tspan(i);   
        pos(i) = find(abs(tdiff) == min(abs(tdiff)),1,'first');    
        pos(i) = max(1,pos(i));        
    end    
    
    % compute the control
    y = obs.init.Y_full_story(obs.init.traj).val(1,:,pos(1))';
    y_hat = obs.init.Yhat_full_story(obs.init.traj).val(1,:,pos(1))';
    drive(1:6) = y(params.pos_uwb_out) - y_hat(params.pos_uwb_out);% y(params.pos_uwb_out) - y_hat([params.pos_obs params.pos_obs]);%
    drive(7:12) = y(params.pos_uwb_out_der) - y_hat(params.pos_uwb_out_der);%y(params.pos_uwb_out) - y_hat([params.pos_obs params.pos_obs]);%
    drive(13:18) = x([params.pos_p params.pos_eul]);
    params.u = params.input(tspan,drive,params,obs);
    obs.init.params.drive_story(:,pos(end)) = drive;

    obs.init.input_story(obs.init.traj).val(:,pos(1)) = params.u(:,1);  
    

    % noise dynamics
%    x_dot(params.pos_bias_v) = 0*(x(params.pos_bias_v) + params.bias_v_enable*ones(3,1)*sin(tspan(1)));
    
    % switch gamma
    % if tspan > 20
    %     tmp = params.gamma(1:3);
    %     params.gamma(1:3) = params.gamma(4:6);
    %     params.gamma(4:6) = tmp;
    % end
    % 
    % if tspan > 100
    %     tmp = params.gamma(1:3);
    %     params.gamma(1:3) = params.gamma(4:6);
    %     params.gamma(4:6) = tmp;
    % end

  
    
    obs.init.params.gamma_story(round((tspan*100)+2),:) = params.gamma';

    obs.init.params.gamma_state(round((tspan*100)+2),:) = x(params.pos_gamma);

    obs.init.params.err(round(tspan*100)+1) = norm(x(params.pos_obs)-x(params.pos_p));
    

    y = obs.init.Yhat_full_story(obs.init.traj).val(1,:,pos(1))';
    
    %%% model dynamics - translation (Z)    
    % x_dot(params.pos_obs) = (1-(params.Ts*params.gamma(3)))*x(params.pos_obs) + (params.gamma(3)*params.Ts)*(params.gamma(1)*y(params.pos_uwb_out(1:3)) + params.gamma(2)*y(params.pos_cam_out(1:3)));
    
    %%% model dynamics - translation (C)    
    x_dot(params.pos_obs) =  (1/(params.Ts*params.gamma(3)))*(-x(params.pos_obs) + params.gamma(1)*y(params.pos_uwb_out(1:3)) + params.gamma(2)*y(params.pos_cam_out(1:3)));%-x(params.pos_p)
    
    obs.init.params.obs(:,pos(end)) = x(params.pos_obs);

    % Drone dynamics (C)
    x_dot(params.pos_p) = x(params.pos_v);
    
    x_dot(params.pos_eul) = x(params.pos_o);
    
   
    
    x_dot(params.pos_v(1)) = (params.k*(sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(3))) + cos(x(params.pos_eul(1)))*cos(x(params.pos_eul(3)))*sin(x(params.pos_eul(2))))*(params.u(1) + params.u(2) + params.u(3) + params.u(4)))/params.m;
    x_dot(params.pos_v(2)) = -(params.k*(cos(x(params.pos_eul(3)))*sin(x(params.pos_eul(1))) - cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(3)))*sin(x(params.pos_eul(2))))*(params.u(1) + params.u(2) + params.u(3) + params.u(4)))/params.m;
    x_dot(params.pos_v(3)) = (params.k*cos(x(params.pos_eul(1)))*cos(x(params.pos_eul(2)))*(params.u(1) + params.u(2) + params.u(3) + params.u(4)))/params.m - params.g;
    x_dot(params.pos_o(1)) = ((x(params.pos_o(2))*((x(params.pos_o(3))*(params.Iyy*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Iyy*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 + params.Izz*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2))/2 - (x(params.pos_o(2))*(2*params.Iyy*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1))) - 2*params.Izz*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))))/2) + x(params.pos_o(3))*((x(params.pos_o(2))*(params.Iyy*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Iyy*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 + params.Izz*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2))/2 + (x(params.pos_o(3))*(2*params.Iyy*cos(x(params.pos_eul(1)))*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1))) - 2*params.Izz*cos(x(params.pos_eul(1)))*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1)))))/2 + params.Ixx*x(params.pos_o(2))*cos(x(params.pos_eul(2)))) - params.k*params.l*(params.u(2) - params.u(4)))*(params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^4*cos(x(params.pos_eul(2)))^2 + params.Ixx*params.Iyy*cos(x(params.pos_eul(1)))^2*sin(x(params.pos_eul(2)))^2 + params.Iyy*params.Izz*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1)))^4 + params.Ixx*params.Izz*sin(x(params.pos_eul(1)))^2*sin(x(params.pos_eul(2)))^2 + 2*params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1)))^2))/(params.Ixx*params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^4*cos(x(params.pos_eul(2)))^2 + params.Ixx*params.Iyy*params.Izz*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1)))^4 + 2*params.Ixx*params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1)))^2) + (sin(x(params.pos_eul(2)))*(params.Iyy*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1))) - params.Izz*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1))))*(x(params.pos_o(2))*((x(params.pos_o(3))*(params.Iyy*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2))) - params.Izz*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2)))))/2 - 2*params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1))) + 2*params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))) + x(params.pos_o(3))*((x(params.pos_o(2))*(params.Iyy*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2))) - params.Izz*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2)))))/2 + (x(params.pos_o(3))*(2*params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(2))) - 2*params.Ixx*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(2))) + 2*params.Iyy*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2*sin(x(params.pos_eul(2)))))/2 + (params.Ixx*x(params.pos_o(1))*cos(x(params.pos_eul(2))))/2 + params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 + params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 - params.Iyy*x(params.pos_o(2))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2))) + params.Izz*x(params.pos_o(2))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2)))) + params.k*params.l*(params.u(1) - params.u(3)) + (params.Ixx*x(params.pos_o(1))*x(params.pos_o(3))*cos(x(params.pos_eul(2))))/2))/(params.Iyy*params.Izz*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^4 + params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^4*cos(x(params.pos_eul(2))) + 2*params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2) + (sin(x(params.pos_eul(2)))*(params.Iyy*cos(x(params.pos_eul(1)))^2 + params.Izz*sin(x(params.pos_eul(1)))^2)*(x(params.pos_o(3))*(2*params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(1)))*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1))) - 2*params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(1)))*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1))) - 2*params.Ixx*x(params.pos_o(2))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(2))) + 2*params.Izz*x(params.pos_o(2))*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(2))) + 2*params.Iyy*x(params.pos_o(2))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2*sin(x(params.pos_eul(2)))) - x(params.pos_o(2))*(params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 + params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 - params.Iyy*x(params.pos_o(2))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2))) + params.Izz*x(params.pos_o(2))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2)))) - params.b*(params.u(1) - params.u(2) + params.u(3) - params.u(4)) + params.Ixx*x(params.pos_o(1))*x(params.pos_o(2))*cos(x(params.pos_eul(2)))))/(params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^4*cos(x(params.pos_eul(2)))^2 + params.Iyy*params.Izz*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1)))^4 + 2*params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1)))^2);
    x_dot(params.pos_o(2)) = -((params.Izz*cos(x(params.pos_eul(1)))^2 + params.Iyy*sin(x(params.pos_eul(1)))^2)*(x(params.pos_o(2))*((x(params.pos_o(3))*(params.Iyy*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2))) - params.Izz*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2)))))/2 - 2*params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1))) + 2*params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))) + x(params.pos_o(3))*((x(params.pos_o(2))*(params.Iyy*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2))) - params.Izz*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2)))))/2 + (x(params.pos_o(3))*(2*params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(2))) - 2*params.Ixx*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(2))) + 2*params.Iyy*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2*sin(x(params.pos_eul(2)))))/2 + (params.Ixx*x(params.pos_o(1))*cos(x(params.pos_eul(2))))/2 + params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 + params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 - params.Iyy*x(params.pos_o(2))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2))) + params.Izz*x(params.pos_o(2))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2)))) + params.k*params.l*(params.u(1) - params.u(3)) + (params.Ixx*x(params.pos_o(1))*x(params.pos_o(3))*cos(x(params.pos_eul(2))))/2))/(params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^4 + params.Iyy*params.Izz*sin(x(params.pos_eul(1)))^4 + 2*params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^2*sin(x(params.pos_eul(1)))^2) - ((params.Iyy*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1))) - params.Izz*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1))))*(x(params.pos_o(3))*(2*params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(1)))*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1))) - 2*params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(1)))*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1))) - 2*params.Ixx*x(params.pos_o(2))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(2))) + 2*params.Izz*x(params.pos_o(2))*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(2))) + 2*params.Iyy*x(params.pos_o(2))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2*sin(x(params.pos_eul(2)))) - x(params.pos_o(2))*(params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 + params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 - params.Iyy*x(params.pos_o(2))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2))) + params.Izz*x(params.pos_o(2))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2)))) - params.b*(params.u(1) - params.u(2) + params.u(3) - params.u(4)) + params.Ixx*x(params.pos_o(1))*x(params.pos_o(2))*cos(x(params.pos_eul(2)))))/(params.Iyy*params.Izz*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^4 + params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^4*cos(x(params.pos_eul(2))) + 2*params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2) - (sin(x(params.pos_eul(2)))*(params.Iyy*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1))) - params.Izz*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1))))*(x(params.pos_o(2))*((x(params.pos_o(3))*(params.Iyy*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Iyy*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 + params.Izz*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2))/2 - (x(params.pos_o(2))*(2*params.Iyy*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1))) - 2*params.Izz*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))))/2) + x(params.pos_o(3))*((x(params.pos_o(2))*(params.Iyy*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Iyy*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 + params.Izz*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2))/2 + (x(params.pos_o(3))*(2*params.Iyy*cos(x(params.pos_eul(1)))*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1))) - 2*params.Izz*cos(x(params.pos_eul(1)))*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1)))))/2 + params.Ixx*x(params.pos_o(2))*cos(x(params.pos_eul(2)))) - params.k*params.l*(params.u(2) - params.u(4))))/(params.Iyy*params.Izz*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^4 + params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^4*cos(x(params.pos_eul(2))) + 2*params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2);
    x_dot(params.pos_o(3)) = ((params.Iyy*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1))) - params.Izz*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1))))*(x(params.pos_o(2))*((x(params.pos_o(3))*(params.Iyy*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2))) - params.Izz*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2)))))/2 - 2*params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1))) + 2*params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))) + x(params.pos_o(3))*((x(params.pos_o(2))*(params.Iyy*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2))) - params.Izz*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2)))))/2 + (x(params.pos_o(3))*(2*params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(2))) - 2*params.Ixx*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(2))) + 2*params.Iyy*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2*sin(x(params.pos_eul(2)))))/2 + (params.Ixx*x(params.pos_o(1))*cos(x(params.pos_eul(2))))/2 + params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 + params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 - params.Iyy*x(params.pos_o(2))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2))) + params.Izz*x(params.pos_o(2))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2)))) + params.k*params.l*(params.u(1) - params.u(3)) + (params.Ixx*x(params.pos_o(1))*x(params.pos_o(3))*cos(x(params.pos_eul(2))))/2))/(params.Iyy*params.Izz*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^4 + params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^4*cos(x(params.pos_eul(2))) + 2*params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2) + ((params.Iyy*cos(x(params.pos_eul(1)))^2 + params.Izz*sin(x(params.pos_eul(1)))^2)*(x(params.pos_o(3))*(2*params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(1)))*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1))) - 2*params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(1)))*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1))) - 2*params.Ixx*x(params.pos_o(2))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(2))) + 2*params.Izz*x(params.pos_o(2))*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(2))) + 2*params.Iyy*x(params.pos_o(2))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2*sin(x(params.pos_eul(2)))) - x(params.pos_o(2))*(params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Iyy*x(params.pos_o(1))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 + params.Izz*x(params.pos_o(1))*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 - params.Iyy*x(params.pos_o(2))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2))) + params.Izz*x(params.pos_o(2))*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))*sin(x(params.pos_eul(2)))) - params.b*(params.u(1) - params.u(2) + params.u(3) - params.u(4)) + params.Ixx*x(params.pos_o(1))*x(params.pos_o(2))*cos(x(params.pos_eul(2)))))/(params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^4*cos(x(params.pos_eul(2)))^2 + params.Iyy*params.Izz*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1)))^4 + 2*params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1)))^2) + (sin(x(params.pos_eul(2)))*(params.Iyy*cos(x(params.pos_eul(1)))^2 + params.Izz*sin(x(params.pos_eul(1)))^2)*(x(params.pos_o(2))*((x(params.pos_o(3))*(params.Iyy*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Iyy*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 + params.Izz*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2))/2 - (x(params.pos_o(2))*(2*params.Iyy*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1))) - 2*params.Izz*cos(x(params.pos_eul(1)))*sin(x(params.pos_eul(1)))))/2) + x(params.pos_o(3))*((x(params.pos_o(2))*(params.Iyy*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2))) - params.Iyy*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2 + params.Izz*cos(x(params.pos_eul(2)))*sin(x(params.pos_eul(1)))^2))/2 + (x(params.pos_o(3))*(2*params.Iyy*cos(x(params.pos_eul(1)))*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1))) - 2*params.Izz*cos(x(params.pos_eul(1)))*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1)))))/2 + params.Ixx*x(params.pos_o(2))*cos(x(params.pos_eul(2)))) - params.k*params.l*(params.u(2) - params.u(4))))/(params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^4*cos(x(params.pos_eul(2)))^2 + params.Iyy*params.Izz*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1)))^4 + 2*params.Iyy*params.Izz*cos(x(params.pos_eul(1)))^2*cos(x(params.pos_eul(2)))^2*sin(x(params.pos_eul(1)))^2);
    
    
    
    % Double integrator (C)
    % x_dot(params.pos_p) = x(params.pos_v);
    % x_dot(params.pos_v) = -params.u(1:3);

    % Double integrator (Z)
    % x_dot(params.pos_p) = x(params.pos_p) + x(params.pos_v)*params.Ts;
    % x_dot(params.pos_v) = x(params.pos_v) + params.u(1:3)*params.Ts;

    % parameter dynamics
    %x_dot(params.pos_gamma) = params.gamma; %x(params.pos_gamma); 
end